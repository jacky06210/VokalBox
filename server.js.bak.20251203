/**
 * VOCALBOX - API CENTRALE
 * Serveur Node.js avec Express
 * Briques 1 & 2 int√©gr√©es
 */

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const path = require('path');
const mysql = require('mysql2/promise');

const app = express();
const PORT = process.env.PORT || 3000;

// ========================================
// MIDDLEWARES
// ========================================

// CORS
const corsOptions = {
    origin: process.env.CORS_ORIGINS ? process.env.CORS_ORIGINS.split(',') : '*',
    credentials: true
};
app.use(cors(corsOptions));

// Parser JSON
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Servir les fichiers statiques
app.use(express.static(path.join(__dirname, 'public')));

// Logging des requ√™tes
app.use((req, res, next) => {
    console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
    next();
});

// ========================================
// POOL DE CONNEXIONS MYSQL
// ========================================

const pool = mysql.createPool({
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 3306,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0
});

// Test de connexion au d√©marrage
pool.getConnection()
    .then(connection => {
        console.log('‚úÖ Connexion √† MySQL √©tablie');
        connection.release();
    })
    .catch(err => {
        console.error('‚ùå Erreur connexion MySQL:', err.message);
    });

// Middleware pour attacher le pool aux requ√™tes
app.use((req, res, next) => {
    req.db = pool;
    next();
});
// ========================================
// ROUTES PRINCIPALES
// ========================================

/**
 * Health check
 */
app.get('/health', (req, res) => {
    res.json({
        success: true,
        message: 'API VocalBox op√©rationnelle',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'development'
    });
});

/**
 * Health check base de donn√©es
 */
app.get('/health/db', async (req, res) => {
    try {
        const [rows] = await pool.execute('SELECT 1 as test');
        res.json({
            success: true,
            message: 'Base de donn√©es op√©rationnelle',
            data: rows[0]
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            message: 'Erreur de connexion √† la base de donn√©es',
            error: error.message
        });
    }
});

// ========================================
// ROUTES BRIQUE 1 : VocalBoxMa√Ætre
// ========================================

const menuScanRoutes = require('./routes/menu-scan');
app.use('/api/menu-scan', menuScanRoutes);

// ========================================
// ROUTES BRIQUE 2 : VocalBoxClient (API Centrale)
// ========================================

const ordersRoutes = require('./routes/orders');
const voiceRoutes = require('./routes/voice');
const restaurantsRoutes = require('./routes/restaurants');

app.use('/api/v1/orders', ordersRoutes);
app.use('/api/v1/voice', voiceRoutes);
app.use('/api/v1/restaurants', restaurantsRoutes);

// ========================================
// ROUTE POUR SERVIR VOCALBOXMA√éTRE
// ========================================

app.get('/maitre', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'maitre', 'index.html'));
});

app.get('/maitre/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'maitre', 'index.html'));
});

// ========================================
// GESTION DES ERREURS 404
// ========================================

app.use((req, res) => {
    res.status(404).json({
        success: false,
        message: 'Route non trouv√©e',
        path: req.path
    });
});

// ========================================
// GESTION DES ERREURS GLOBALES
// ========================================

app.use((err, req, res, next) => {
    console.error('Erreur serveur:', err);
    res.status(500).json({
        success: false,
        message: 'Erreur interne du serveur',
        error: process.env.NODE_ENV === 'development' ? err.message : undefined
    });
});

// ========================================
// D√âMARRAGE DU SERVEUR
// ========================================

app.listen(PORT, () => {
    console.log('');
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë         VOCALBOX API - SERVEUR D√âMARR√â          ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log('');
    console.log(`üöÄ Serveur en √©coute sur le port ${PORT}`);
    console.log(`üåç Environnement: ${process.env.NODE_ENV || 'development'}`);
    console.log(`üì° URL locale: http://localhost:${PORT}`);
    console.log('');
    console.log('üìã Routes disponibles:');
    console.log('  ‚Ä¢ GET  /health                          - Health check API');
    console.log('  ‚Ä¢ GET  /health/db                       - Health check DB');
    console.log('');
    console.log('üé® BRIQUE 1 - VocalBoxMa√Ætre:');
    console.log('  ‚Ä¢ GET  /maitre/                         - Interface de num√©risation');
    console.log('  ‚Ä¢ GET  /api/menu-scan/verify/:apiKey    - V√©rifier code restaurant');
    console.log('  ‚Ä¢ POST /api/menu-scan/analyze           - Scanner images');
    console.log('  ‚Ä¢ POST /api/menu-scan/save              - Sauvegarder menu');
    console.log('  ‚Ä¢ GET  /api/menu-scan/menu              - R√©cup√©rer menu');
    console.log('');
    console.log('üéØ BRIQUE 2 - VocalBoxClient (API Centrale):');
    console.log('  üì¶ Commandes:');
    console.log('  ‚Ä¢ POST   /api/v1/orders                 - Cr√©er commande');
    console.log('  ‚Ä¢ GET    /api/v1/orders/:restaurantId   - Liste commandes');
    console.log('  ‚Ä¢ GET    /api/v1/orders/detail/:orderId - D√©tails commande');
    console.log('  ‚Ä¢ PATCH  /api/v1/orders/:id/status      - Changer statut');
    console.log('  ‚Ä¢ DELETE /api/v1/orders/:id             - Annuler commande');
    console.log('  ‚Ä¢ GET    /api/v1/stats/:restaurantId    - Statistiques');
    console.log('');
    console.log('  üìû Voice (Telnyx):');
    console.log('  ‚Ä¢ GET  /api/v1/voice/menu/:apiKey       - Menu pour vocal');
    console.log('  ‚Ä¢ POST /api/v1/voice/order              - Commande vocale');
    console.log('  ‚Ä¢ POST /api/v1/voice/confirm-sms        - SMS confirmation');
    console.log('');
    console.log('  üè¢ Restaurants:');
    console.log('  ‚Ä¢ GET    /api/v1/restaurants            - Liste restaurants');
    console.log('  ‚Ä¢ GET    /api/v1/restaurants/:key/info  - Infos restaurant');
    console.log('  ‚Ä¢ POST   /api/v1/restaurants            - Cr√©er restaurant');
    console.log('  ‚Ä¢ PUT    /api/v1/restaurants/:id        - Modifier restaurant');
    console.log('  ‚Ä¢ DELETE /api/v1/restaurants/:id        - Supprimer restaurant');
    console.log('');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log('');
});

// Gestion propre de l'arr√™t
process.on('SIGTERM', () => {
    console.log('SIGTERM re√ßu, fermeture du serveur...');
    pool.end();
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('SIGINT re√ßu, fermeture du serveur...');
    pool.end();
    process.exit(0);
});
