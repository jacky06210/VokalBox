<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocalBox Ma√Ætre - Num√©risation de Menus</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .content { padding: 40px; }
        .login-section {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }
        .login-section h2 { color: #333; margin-bottom: 30px; }
        .login-section input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .login-section input:focus { outline: none; border-color: #667eea; }
        .main-section { display: none; }
        .button-group {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .btn {
            flex: 1;
            min-width: 200px;
            padding: 20px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
            margin-bottom: 30px;
        }
        .upload-zone:hover { background: #e9ecef; border-color: #764ba2; }
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .preview-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .preview-item img { width: 100%; height: 150px; object-fit: cover; }
        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .menu-editor {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .category-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .category-header h3 { color: #667eea; font-size: 1.3em; }
        .add-item-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .menu-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 2fr 1fr 2fr auto;
            gap: 10px;
            align-items: center;
        }
        .menu-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #c3e6cb;
            text-align: center;
        }
        .api-key-display {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 16px;
            word-break: break-all;
            margin: 15px 0;
            border: 2px solid #28a745;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { color: #333; }
        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }
        .error-box {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        .debug-box {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ VocalBox Ma√Ætre</h1>
            <p>Num√©risation de menus avec Claude Vision</p>
        </div>

        <div class="content">
            <!-- LOGIN -->
            <div class="login-section" id="loginSection">
                <h2>üîê Authentification</h2>
                <input type="password" id="passwordInput" placeholder="Mot de passe" onkeypress="if(event.key==='Enter')login()">
                <button class="btn btn-primary" onclick="login()">Se connecter</button>
            </div>

            <!-- MAIN -->
            <div class="main-section" id="mainSection">
                <div class="button-group">
                    <button class="btn btn-primary" onclick="openScanner()">üì∏ Scanner un menu</button>
                    <button class="btn btn-success" onclick="downloadJSON()" id="downloadBtn" disabled>üì• T√©l√©charger JSON</button>
                </div>
                <div id="resultSection"></div>
            </div>
        </div>
    </div>

    <!-- MODAL SCANNER -->
    <div class="modal" id="scannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Scanner un menu</h2>
                <button class="close-btn" onclick="closeScanner()">&times;</button>
            </div>

            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <h3>üìÅ Cliquez pour uploader vos images</h3>
                <p>Maximum 7 images, moins de 3MB chacune</p>
                <input type="file" id="fileInput" accept="image/*" multiple style="display:none" onchange="handleFiles(this.files)">
            </div>

            <div class="preview-container" id="previewContainer"></div>

            <button class="btn btn-primary" onclick="analyzeMenu()" id="analyzeBtn" disabled style="width:100%">
                ‚ö° Analyser (10-30 secondes)
            </button>

            <div id="loadingSection" class="loading" style="display:none">
                <div class="spinner"></div>
                <p>Analyse en cours avec Claude Vision...</p>
            </div>

            <div id="errorSection"></div>
            <div id="debugSection"></div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const PASSWORD = 'bouriquetJ.123';
        const API_URL = 'https://api.vokalbox.fr/api/menu-scan';
        const DEBUG = true;

        let uploadedImages = [];
        let currentMenu = null;
        let cart = [];

        // ===== UTILITAIRES =====
        function log(msg, data) {
            if (!DEBUG) return;
            console.log(msg, data);
            const el = document.getElementById('debugSection');
            el.innerHTML = `<div class="debug-box"><strong>${msg}</strong>\n${JSON.stringify(data, null, 2)}</div>`;
        }

        function showError(msg) {
            document.getElementById('errorSection').innerHTML = `<div class="error-box">‚ùå ${msg}</div>`;
        }

        function clearError() {
            document.getElementById('errorSection').innerHTML = '';
        }

        function showSuccess(msg) {
            document.getElementById('errorSection').innerHTML = `<div style="background:#d1fae5; color:#065f46; padding:15px; margin:20px 0; border-radius:8px; border-left:4px solid #10b981;">‚úÖ ${msg}</div>`;
            setTimeout(() => document.getElementById('errorSection').innerHTML = '', 3000);
        }

        // ===== LOGIN =====
        function login() {
            if (document.getElementById('passwordInput').value === PASSWORD) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'block';
            } else {
                alert('‚ùå Mot de passe incorrect');
            }
        }

        // ===== SCANNER =====
        function openScanner() {
            document.getElementById('scannerModal').style.display = 'flex';
            uploadedImages = [];
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('debugSection').innerHTML = '';
            clearError();
        }

        function closeScanner() {
            document.getElementById('scannerModal').style.display = 'none';
        }

        function handleFiles(files) {
            clearError();
            Array.from(files).forEach(file => {
                if (file.size > 3 * 1024 * 1024) {
                    showError(`Image "${file.name}" trop lourde (max 3MB)`);
                    return;
                }
                if (uploadedImages.length >= 7) {
                    showError('Maximum 7 images');
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    clearError();
                    const dataUrl = e.target.result;
                    const mime = (dataUrl.split(';')[0].split(':')[1] || '').toLowerCase();
                    const base64 = dataUrl.split(',')[1] || '';
                    const approxBytes = Math.floor(base64.length * 3 / 4 - (base64.endsWith('==') ? 2 : (base64.endsWith('=') ? 1 : 0)));
                    const MIN_BYTES = 10 * 1024; // 10 KB
                    const ALLOWED_MIME = ['image/jpeg', 'image/png', 'image/webp'];

                    if (!ALLOWED_MIME.includes(mime)) {
                        showError(`Image "${file.name}" : type non support√© (${mime})`);
                        return;
                    }
                    if (approxBytes < MIN_BYTES) {
                        showError(`Image "${file.name}" trop petite (‚âà${Math.round(approxBytes/1024)} KB). Utilisez une photo plus grande.`);
                        return;
                    }

                    // V√©rifier dimensions r√©elles
                    const imgObj = new Image();
                    imgObj.onload = () => {
                        if (imgObj.naturalWidth < 50 || imgObj.naturalHeight < 50) {
                            showError(`Image "${file.name}" : r√©solution trop petite (${imgObj.naturalWidth}x${imgObj.naturalHeight})`);
                            return;
                        }
                        uploadedImages.push(dataUrl);
                        renderPreviews();
                    };
                    imgObj.onerror = () => {
                        showError(`Image "${file.name}" invalide`);
                    };
                    imgObj.src = dataUrl;
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviews() {
            const container = document.getElementById('previewContainer');
            container.innerHTML = uploadedImages.map((img, i) => `
                <div class="preview-item">
                    <img src="${img}">
                    <button class="remove-btn" onclick="removeImage(${i})">√ó</button>
                </div>
            `).join('');
            document.getElementById('analyzeBtn').disabled = uploadedImages.length === 0;
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderPreviews();
        }

        // ===== ANALYSE =====
        async function analyzeMenu() {
            if (uploadedImages.length === 0) return;

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingSection').style.display = 'block';
            clearError();

            try {
                log('Envoi requ√™te', { nbImages: uploadedImages.length });

                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': 'REST-001' },
                    body: JSON.stringify({ images: uploadedImages })
                });

                log('R√©ponse HTTP', { status: response.status });

                if (!response.ok) {
                    let txt = await response.text();
                    // Essayer d'extraire un message JSON si possible
                    try {
                        const json = JSON.parse(txt);
                        txt = json.error || JSON.stringify(json);
                    } catch (e) {
                        const m = txt.match(/\d{3}\s+({[\s\S]*})/);
                        if (m) {
                            try {
                                const j = JSON.parse(m[1]);
                                txt = j.error || JSON.stringify(j);
                            } catch (e2) { /* fallback */ }
                        }
                    }
                    throw new Error(`Erreur ${response.status}: ${txt}`);
                }

                const data = await response.json();
                log('Donn√©es re√ßues', data);

                // Si l'API retourne success:false, afficher message clair
                if (data && data.success === false) {
                    const serverMsg = typeof data.error === 'string' ? data.error : (data.error && data.error.message) ? data.error.message : JSON.stringify(data.error);
                    throw new Error(serverMsg || 'Erreur serveur');
                }

                // Extraction des cat√©gories (compatible plusieurs formats)
                let categories = {};
                let restaurantName = '';

                if (data.data && data.data.categories) {
                    // Format: { data: { restaurant, categories: [...] } }
                    restaurantName = data.data.restaurant || '';
                    data.data.categories.forEach(cat => {
                        const catName = cat.name || 'Divers';
                        categories[catName] = (cat.items || []).map(item => ({
                            name: item.name || item.nom || '',
                            price: extractPrice(item),
                            description: item.description || ''
                        }));
                    });
                } else if (data.categories) {
                    // Format: { restaurant, categories: [...] }
                    restaurantName = data.restaurant || '';
                    data.categories.forEach(cat => {
                        const catName = cat.name || 'Divers';
                        categories[catName] = (cat.items || []).map(item => ({
                            name: item.name || item.nom || '',
                            price: extractPrice(item),
                            description: item.description || ''
                        }));
                    });
                } else if (data.items) {
                    // Format legacy: { items: [...] }
                    restaurantName = data.restaurantName || '';
                    data.items.forEach(item => {
                        const catName = item.category || 'Divers';
                        if (!categories[catName]) categories[catName] = [];
                        categories[catName].push({
                            name: item.name || '',
                            price: parseFloat(item.price) || 0,
                            description: item.description || ''
                        });
                    });
                }

                if (Object.keys(categories).length === 0) {
                    throw new Error('Aucun plat d√©tect√©');
                }

                currentMenu = { restaurantName, categories };
                log('Menu trait√©', currentMenu);

                closeScanner();
                displayEditor();
                document.getElementById('downloadBtn').disabled = false;

            } catch (err) {
                showError(err.message);
                log('Erreur', { message: err.message });
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function extractPrice(item) {
            if (item.price !== undefined) return parseFloat(item.price) || 0;
            if (item.prix !== undefined) return parseFloat(item.prix) || 0;
            if (item.prices && item.prices.length > 0) {
                return parseFloat(item.prices[0].value) || 0;
            }
            return 0;
        }

        // ===== EDITEUR =====
        function displayEditor() {
            const section = document.getElementById('resultSection');
            const catCount = Object.keys(currentMenu.categories).length;
            const itemCount = Object.values(currentMenu.categories).flat().length;

            let html = `
                <div class="menu-editor">
                    <div class="form-group">
                        <label>Nom du restaurant</label>
                        <input type="text" id="restaurantName" oninput="updateSlug()" value="${esc(currentMenu.restaurantName)}" placeholder="Nom du restaurant">
                    </div>
                    <div class="form-group">
                        <label>Code restaurant (ex: LAPART001)</label>
                        <input type="text" id="restaurantCode" placeholder="Code unique du restaurant">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="phoneNumber" placeholder="Ex: 01234567890">
                    </div>
                    <div class="form-group">
                        <label>Adresse (rue)</label>
                        <input type="text" id="addressStreet" placeholder="123 Rue de la Pizza">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div class="form-group">
                            <label>Code postal</label>
                            <input type="text" id="addressPostal" placeholder="75001">
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <input type="text" id="addressCity" placeholder="Paris">
                        </div>
                    </div>
                    <!-- NOUVEAUX CHAMPS ONBOARDING -->
                    <div class="form-group">
                        <label>Slug (URL)</label>
                        <input type="text" id="restaurantSlug" placeholder="cap-pizza" readonly style="background:#f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="restaurantEmail" placeholder="contact@resto.fr">
                    </div>
                    <div class="form-group">
                        <label>Horaires d'ouverture</label>
                        <div id="horairesContainer" style="background:#f8f9fa; padding:15px; border-radius:8px; border:2px solid #ddd;">
                            <div style="display:grid; grid-template-columns:100px 1fr 1fr 60px; gap:10px; margin-bottom:10px; font-weight:bold; font-size:13px; color:#666;">
                                <span>Jour</span>
                                <span>Midi</span>
                                <span>Soir</span>
                                <span>Ferm√©</span>
                            </div>
                            <div id="horairesList"></div>
                        </div>
                        <input type="hidden" id="restaurantHoraires">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div class="form-group">
                            <label>Facebook</label>
                            <input type="url" id="restaurantFacebook" placeholder="https://facebook.com/resto">
                        </div>
                        <div class="form-group">
                            <label>Instagram</label>
                            <input type="url" id="restaurantInstagram" placeholder="https://instagram.com/resto">
                        </div>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="restaurantLivraison"> Livraison disponible</label>
                    </div>

                    <!-- SECTION SITE VITRINE -->
                    <div class="vitrine-section" id="vitrineSection" style="display:none; margin:20px 0; padding:20px; background:#f8f4ff; border-radius:8px; border-left:4px solid #8b5cf6;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0; color:#7c3aed;">üìå Site Vitrine</h3>
                            <span id="vitrineCount" style="background:#7c3aed; color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:bold;">0 plats</span>
                        </div>
                        <div id="vitrineList" style="background:white; padding:15px; border-radius:6px; margin-bottom:15px; min-height:50px;" data-plats="[]">
                            <p style="color:#999; text-align:center; margin:0;">Aucun plat en vitrine. Cliquez sur l'ic√¥ne ‚≠ê d'un plat pour l'ajouter.</p>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="validateVitrine()" style="flex:1; padding:12px; background:#7c3aed; color:white; border:none; border-radius:6px; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                                ‚úÖ Valider le site vitrine
                            </button>
                            <button onclick="saveToGitHub()" style="flex:1; padding:12px; background:#10b981; color:white; border:none; border-radius:6px; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.2s;">
                                üíæ Sauvegarder sur GitHub
                            </button>
                        </div>
                    </div>
                    <!-- FIN SECTION SITE VITRINE -->

                    <h3 style="margin-bottom:10px">üìã ${catCount} cat√©gories, ${itemCount} plats</h3>
                    <div style="display:flex; gap:20px; margin-bottom:20px; padding:10px; background:#f8fafc; border-radius:6px; font-size:13px;">
                        <span style="display:flex; align-items:center; gap:6px;">
                            <span style="width:24px; height:24px; background:#3b82f6; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:14px;">‚ûï</span>
                            <span style="color:#666;">Panier</span>
                        </span>
                        <span style="display:flex; align-items:center; gap:6px;">
                            <span style="width:24px; height:24px; background:#dc2626; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:14px;">üè∑Ô∏è</span>
                            <span style="color:#666;">Promo</span>
                        </span>
                        <span style="display:flex; align-items:center; gap:6px;">
                            <span style="width:24px; height:24px; background:#f59e0b; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:14px;">üóëÔ∏è</span>
                            <span style="color:#666;">Supprimer</span>
                        </span>
                        <span style="display:flex; align-items:center; gap:6px;">
                            <span style="width:24px; height:24px; background:#10b981; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:14px;">‚≠ê</span>
                            <span style="color:#666;">Vitrine</span>
                        </span>
                    </div>
            `;

            for (const [catName, items] of Object.entries(currentMenu.categories)) {
                html += `
                    <div class="category-section">
                        <div class="category-header">
                            <h3>${esc(catName)}</h3>
                            <button class="add-item-btn" onclick="addItem('${escJs(catName)}')">+ Ajouter</button>
                        </div>
                `;
                items.forEach((item, i) => {
                    // Calcul du prix avec promo si applicable
                    const prixOriginal = parseFloat(item.price) || 0;
                    const promoPercent = parseFloat(item.promo_pourcentage) || 0;
                    const prixPromo = promoPercent > 0 ? prixOriginal * (1 - promoPercent / 100) : null;
                    
                    let prixDisplay = '';
                    if (prixPromo !== null && promoPercent > 0) {
                        // AVEC PROMO : afficher UNIQUEMENT prix barr√© + prix promo (pas d'input)
                        prixDisplay = `
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="text-decoration:line-through; color:#999; font-size:16px;">${prixOriginal.toFixed(2)}‚Ç¨</span>
                                <span style="color:#dc2626; font-weight:bold; font-size:18px;">${prixPromo.toFixed(2)}‚Ç¨</span>
                            </div>
                        `;
                    } else {
                        // SANS PROMO : afficher input prix normal avec symbole ‚Ç¨
                        prixDisplay = `
                            <div style="display:flex; align-items:center; gap:4px;">
                                <input type="number" step="0.01" value="${item.price||''}" placeholder="Prix" onchange="updateItem('${escJs(catName)}',${i},'price',this.value)" style="flex:1;">
                                <span style="color:#666; font-size:14px;">‚Ç¨</span>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="menu-item">
                            <input type="text" value="${esc(item.name)}" placeholder="Nom" onchange="updateItem('${escJs(catName)}',${i},'name',this.value)">
                            ${prixDisplay}
                            <input type="text" value="${esc(item.description)}" placeholder="Description" onchange="updateItem('${escJs(catName)}',${i},'description',this.value)">
                            <div style="display:flex; gap:5px; justify-content:flex-end;">
                                <button class="cart-btn" onclick="addToCart('${escJs(catName)}',${i})" title="Ajouter au panier" style="width:35px; height:35px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;">‚ûï</button>
                                <button class="promo-btn" onclick="openPromoPopup('${escJs(catName)}',${i})" title="D√©finir une promo" style="width:35px; height:35px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;">üè∑Ô∏è</button>
                                <button class="delete-btn" onclick="deleteItem('${escJs(catName)}',${i})" title="Supprimer" style="width:35px; height:35px; background:#f59e0b; color:white; border:none; border-radius:6px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;">üóëÔ∏è</button>
                                <button class="vitrine-btn" onclick="toggleVitrine('${escJs(catName)}',${i})" title="Ajouter √† la vitrine" style="width:35px; height:35px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;">‚≠ê</button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            html += `
                <button class="btn btn-success" onclick="saveMenu()" style="width:100%;margin-top:20px">
                    üíæ Sauvegarder et g√©n√©rer cl√© API
                </button>
            </div>`;

            section.innerHTML = html;
            initHoraires();
            updateHorairesHidden();
        }


        // ===== G√âN√âRATION SLUG =====
        // ===== GESTION HORAIRES =====
        const jours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        function initHoraires() {
            const container = document.getElementById('horairesList');
            if (!container) return;
            let html = '';
            for (let i = 0; i < jours.length; i++) {
                html += '<div style="display:grid;grid-template-columns:100px 1fr 1fr 60px;gap:10px;margin-bottom:8px;align-items:center;">';
                html += '<span style="font-weight:600;">' + jours[i] + '</span>';
                html += '<div style="display:flex;gap:5px;align-items:center;"><input type="time" id="midi_ouv_' + i + '" value="11:30" style="padding:5px;border:1px solid #ddd;border-radius:4px;"><span>-</span><input type="time" id="midi_fer_' + i + '" value="14:00" style="padding:5px;border:1px solid #ddd;border-radius:4px;"></div>';
                html += '<div style="display:flex;gap:5px;align-items:center;"><input type="time" id="soir_ouv_' + i + '" value="18:30" style="padding:5px;border:1px solid #ddd;border-radius:4px;"><span>-</span><input type="time" id="soir_fer_' + i + '" value="22:00" style="padding:5px;border:1px solid #ddd;border-radius:4px;"></div>';
                html += '<div style="text-align:center;"><input type="checkbox" id="ferme_' + i + '" onchange="toggleJour(' + i + ')" style="width:18px;height:18px;"></div>';
                html += '</div>';
            }
            container.innerHTML = html;
        }
        function toggleJour(index) {
            const ferme = document.getElementById('ferme_' + index).checked;
            const prefixes = ['midi_ouv_', 'midi_fer_', 'soir_ouv_', 'soir_fer_'];
            for (let p = 0; p < prefixes.length; p++) {
                const input = document.getElementById(prefixes[p] + index);
                if (input) { input.disabled = ferme; input.style.opacity = ferme ? '0.4' : '1'; }
            }
            updateHorairesHidden();
        }
        function updateHorairesHidden() {
            let horaires = '';
            for (let i = 0; i < jours.length; i++) {
                const ferme = document.getElementById('ferme_' + i);
                if (ferme && ferme.checked) { horaires += jours[i] + ': Ferme | '; }
                else {
                    const mo = document.getElementById('midi_ouv_' + i);
                    const mf = document.getElementById('midi_fer_' + i);
                    const so = document.getElementById('soir_ouv_' + i);
                    const sf = document.getElementById('soir_fer_' + i);
                    horaires += jours[i] + ': ' + (mo ? mo.value : '') + '-' + (mf ? mf.value : '') + ', ' + (so ? so.value : '') + '-' + (sf ? sf.value : '') + ' | ';
                }
            }
            const hidden = document.getElementById('restaurantHoraires');
            if (hidden) hidden.value = horaires;
        }
        function generateSlug(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function updateSlug() {
            const nameInput = document.getElementById('restaurantName');
            const slugInput = document.getElementById('restaurantSlug');
            if (nameInput && slugInput) {
                slugInput.value = generateSlug(nameInput.value);
            }
        }

        function esc(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function escJs(str) {
            if (!str) return '';
            return String(str).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
        }

        function updateItem(cat, index, field, value) {
            if (field === 'price') {
                currentMenu.categories[cat][index][field] = parseFloat(value) || 0;
            } else {
                currentMenu.categories[cat][index][field] = value;
            }
        }

        function deleteItem(cat, index) {
            if (!confirm('Supprimer ce plat ?')) return;
            currentMenu.categories[cat].splice(index, 1);
            if (currentMenu.categories[cat].length === 0) {
                delete currentMenu.categories[cat];
            }
            displayEditor();
        }

        function addItem(cat) {
            currentMenu.categories[cat].push({ name: '', price: 0, description: '' });
            displayEditor();
        }

        // ===== SAUVEGARDE =====
        async function saveMenu() {
            const name = document.getElementById('restaurantName').value.trim();
            const restaurantCode = document.getElementById('restaurantCode').value.trim();
            
            if (!name) return alert('Entrez le nom du restaurant');
            if (!restaurantCode) return alert('Entrez le code du restaurant');
            if (!confirm(`Sauvegarder "${name}" ?`)) return;

            try {
                // Collecter les donn√©es du formulaire
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const addressStreet = document.getElementById('addressStreet').value.trim();
                const addressPostal = document.getElementById('addressPostal').value.trim();
                const addressCity = document.getElementById('addressCity').value.trim();
                const slug = document.getElementById('restaurantSlug').value.trim();
                const email = document.getElementById('restaurantEmail').value.trim();
                const horaires = document.getElementById('restaurantHoraires').value.trim();
                const facebook = document.getElementById('restaurantFacebook').value.trim();
                const instagram = document.getElementById('restaurantInstagram').value.trim();
                const livraison = document.getElementById('restaurantLivraison').checked;
                
                // Pr√©parer le payload
                // Transformer la structure pour l'API
                // De: {catName: [{name, price, description}]}
                // Vers: [{name, items: [{name, description, prices: [{label, value}]}]}]
                const categoriesArray = Object.entries(currentMenu.categories).map(([catName, items]) => ({
                    name: catName,
                    items: items.map(item => ({
                        name: item.name,
                        description: item.description || null,
                        prices: item.price ? [{
                            label: 'Prix unique',
                            value: item.price.toString(),
                            originalPrice: null,
                            promo: null
                        }] : []
                    }))
                }));

                const payload = {
                    restaurantName: name,
                    restaurantCode: restaurantCode,
                    phoneNumber: phoneNumber || undefined,
                    address: {
                        street: addressStreet || undefined,
                        postalCode: addressPostal || undefined,
                        city: addressCity || undefined
                    },
                    slug: slug || undefined,
                    horaires: horaires || undefined,
                    facebook: facebook || undefined,
                    instagram: instagram || undefined,
                    livraison: livraison,
                    contact: {
                        email: email || undefined
                    },
                    menuData: {
                        categories: categoriesArray
                    }
                };

                const response = await fetch(`${API_URL}/save-with-restaurant`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': 'REST-001' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                log('Sauvegarde', result);

                if (!response.ok || result.success === false) {
                    throw new Error(result.message || result.error || 'Erreur sauvegarde');
                }

                const apiKey = result.apiKey || result.api_key || 'Non g√©n√©r√©';
                const count = result.itemsCount || result.totalPlats || Object.values(currentMenu.categories).flat().length;

                document.getElementById('resultSection').innerHTML = `
                    <div class="success-message">
                        <h3>‚úÖ Menu sauvegard√© !</h3>
                        <p><strong>Restaurant :</strong> ${esc(name)}</p>
                        <p><strong>Code :</strong> ${esc(restaurantCode)}</p>
                        <p><strong>Plats :</strong> ${count}</p>
                        <h4 style="margin-top:15px">üîë Cl√© API :</h4>
                        <div class="api-key-display">${esc(apiKey)}</div>
                        <p><small>Conservez cette cl√© pour VocalBoxCommande</small></p>
                        <h4 style="margin-top:15px">üåê Lien commande client :</h4>
                        <div class="api-key-display" style="background:#10b981;">vokalbox.fr/resto/${esc(slug)}</div>
                        <p><small>üìû R√©pondeur vocal : Actif sur ${esc(phoneNumber)}</small></p>
                        <button class="btn" onclick="displayEditor()" style="margin-top:15px; margin-right:10px; background:#6b7280; color:white;">
                            ‚Üê Retour √† l'√©diteur
                        </button>
                        <button class="btn btn-primary" onclick="location.reload()" style="margin-top:15px">
                            üì∏ Nouveau scan
                        </button>
                    </div>
                `;

            } catch (err) {
                alert('‚ùå ' + err.message);
            }
        }

        // ===== DOWNLOAD =====
        function downloadJSON() {
            if (!currentMenu) return;
            const name = document.getElementById('restaurantName')?.value || 'menu';
            const blob = new Blob([JSON.stringify(currentMenu, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name.replace(/\s+/g, '-').toLowerCase() + '.json';
            a.click();
        }

        // Fonction pour valider le site vitrine
        function validateVitrine() {
            const vitrineList = document.getElementById('vitrineList');
            if (!vitrineList || !vitrineList.dataset.plats) {
                showError('Aucun plat en vitrine');
                return;
            }
            
            const platsVitrine = JSON.parse(vitrineList.dataset.plats || '[]');
            if (platsVitrine.length === 0) {
                showError('Aucun plat en vitrine');
                return;
            }
            
            showSuccess('‚úÖ Site vitrine valid√© avec succ√®s !');
            console.log('Plats en vitrine:', platsVitrine);
        }

        // Fonction pour sauvegarder le restaurant sur GitHub
        async function saveToGitHub() {
            // R√©cup√©rer le phone_number du restaurant actuel
            const phoneInput = document.getElementById('phoneNumber');
            if (!phoneInput) {
                showError('‚ùå Champ t√©l√©phone introuvable');
                return;
            }
            
            const phone = phoneInput.value.trim();
            
            if (!phone) {
                showError('‚ùå Aucun num√©ro de t√©l√©phone saisi');
                return;
            }
            
            try {
                showSuccess('‚è≥ Sauvegarde en cours...');
                
                const response = await fetch(`/api/menu-scan/export/${phone}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'REST-001'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('üíæ Restaurant sauvegard√© sur GitHub avec succ√®s !');
                    console.log('Export r√©ussi:', data.output);
                } else {
                    showError('‚ùå Erreur: ' + data.error);
                    console.error('Erreur export:', data);
                }
            } catch (error) {
                showError('‚ùå Erreur de sauvegarde: ' + error.message);
                console.error('Erreur:', error);
            }
        }

        // ===== FONCTIONS PANIER =====
        
        // Ajouter au panier
        function addToCart(cat, index) {
            if (!currentMenu || !currentMenu.categories[cat]) return;
            const item = currentMenu.categories[cat][index];
            if (!item) return;
            
            // Calculer le prix avec promo si applicable
            let prix = parseFloat(item.price) || 0;
            if (item.promo_pourcentage > 0) {
                prix = prix * (1 - item.promo_pourcentage / 100);
            }
            
            // V√©rifier si d√©j√† dans le panier
            const existingIndex = cart.findIndex(c => c.name === item.name && c.cat === cat);
            if (existingIndex >= 0) {
                cart[existingIndex].quantity += 1;
            } else {
                cart.push({
                    name: item.name,
                    cat: cat,
                    prix: prix,
                    quantity: 1
                });
            }
            
            updateCartDisplay();
            showSuccess(`${item.name} ajout√© au panier`);
        }

        // Modifier quantit√©
        function updateCartQuantity(index, delta) {
            if (!cart[index]) return;
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            updateCartDisplay();
        }

        // Vider le panier
        function clearCart() {
            cart = [];
            updateCartDisplay();
            showSuccess('Panier vid√©');
        }

        // Mettre √† jour l'affichage
        function updateCartDisplay() {
            const panierList = document.getElementById('panierList');
            const panierTotal = document.getElementById('panierTotal');
            
            if (cart.length === 0) {
                panierList.innerHTML = '<p style="color:#999; text-align:center;">Panier vide</p>';
                panierTotal.textContent = '0.00‚Ç¨';
                return;
            }
            
            let html = '';
            let total = 0;
            
            cart.forEach((item, index) => {
                const sousTotal = item.prix * item.quantity;
                total += sousTotal;
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #e2e8f0;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button onclick="updateCartQuantity(${index}, -1)" style="width:28px; height:28px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">-</button>
                            <span style="font-weight:bold; min-width:20px; text-align:center;">${item.quantity}</span>
                            <button onclick="updateCartQuantity(${index}, 1)" style="width:28px; height:28px; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer;">+</button>
                        </div>
                        <span style="flex:1; margin-left:15px;">${item.name}</span>
                        <span style="font-weight:bold; color:#7c3aed;">${sousTotal.toFixed(2)}‚Ç¨</span>
                    </div>
                `;
            });
            
            panierList.innerHTML = html;
            panierTotal.textContent = total.toFixed(2) + '‚Ç¨';
            updateCartCount();
        }

        // Mettre √† jour le compteur du panier
        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = count;
        }

        // Ouvrir la popup du panier
        function openCartPopup() {
            document.getElementById('cartPopup').style.display = 'flex';
        }

        // Fermer la popup du panier
        function closeCartPopup() {
            document.getElementById('cartPopup').style.display = 'none';
        }

        // Valider la commande
        function validateOrder() {
            if (cart.length === 0) {
                showError('Le panier est vide');
                return;
            }
            
            let recap = 'R√âCAPITULATIF DE COMMANDE\n\n';
            let total = 0;
            cart.forEach(item => {
                const sousTotal = item.prix * item.quantity;
                total += sousTotal;
                recap += `${item.quantity}x ${item.name} : ${sousTotal.toFixed(2)}‚Ç¨\n`;
            });
            recap += `\nTOTAL : ${total.toFixed(2)}‚Ç¨`;
            
            alert(recap);
            showSuccess('Commande valid√©e !');
        }

        // Fonction pour mettre √† jour l'affichage de la vitrine
        function updateVitrineDisplay() {
            const vitrineSection = document.getElementById('vitrineSection');
            const vitrineList = document.getElementById('vitrineList');
            const vitrineCount = document.getElementById('vitrineCount');
            
            if (!vitrineSection || !vitrineList || !vitrineCount) return;
            
            const platsVitrine = JSON.parse(vitrineList.dataset.plats || '[]');
            
            if (platsVitrine.length === 0) {
                vitrineSection.style.display = 'none';
                vitrineList.innerHTML = '<p style="color:#999; text-align:center; margin:0;">Aucun plat en vitrine. Cliquez sur l\'ic√¥ne ‚≠ê d\'un plat pour l\'ajouter.</p>';
                vitrineCount.textContent = '0 plats';
                return;
            }
            
            vitrineSection.style.display = 'block';
            vitrineCount.textContent = `${platsVitrine.length} plat${platsVitrine.length > 1 ? 's' : ''}`;
            
            // Grouper par cat√©gorie
            const groupedByCat = {};
            platsVitrine.forEach(plat => {
                if (!groupedByCat[plat.categorie]) {
                    groupedByCat[plat.categorie] = [];
                }
                groupedByCat[plat.categorie].push(plat);
            });
            
            // Afficher la liste
            let html = '';
            for (const [cat, plats] of Object.entries(groupedByCat)) {
                html += `<div style="margin-bottom:15px;">
                    <h4 style="color:#7c3aed; margin:0 0 8px 0; font-size:14px;">${cat}</h4>`;
                
                plats.forEach(plat => {
                    const prixDisplay = plat.promo_pourcentage > 0 
                        ? `<span style="text-decoration:line-through; color:#999; margin-right:5px;">${plat.prix}‚Ç¨</span><span style="color:#ef4444; font-weight:bold;">${(plat.prix * (1 - plat.promo_pourcentage / 100)).toFixed(2)}‚Ç¨</span>`
                        : `<span style="font-weight:bold;">${plat.prix}‚Ç¨</span>`;
                    
                    html += `<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0;">
                        <span style="color:#333;">${plat.nom}</span>
                        <span>${prixDisplay}</span>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            vitrineList.innerHTML = html;
            vitrineList.dataset.plats = JSON.stringify(platsVitrine);
        }


        // Fonction pour toggle un plat dans la vitrine
        function toggleVitrine(cat, index) {
            if (!currentMenu || !currentMenu.categories[cat]) return;
            
            const item = currentMenu.categories[cat][index];
            if (!item) return;
            
            // Toggle l'√©tat vitrine
            item.vitrine = !item.vitrine;
            item.vitrine_ordre = item.vitrine_ordre || 0;
            
            // Mettre √† jour l'affichage du bouton
            const buttons = document.querySelectorAll('.vitrine-btn');
            buttons.forEach((btn, btnIndex) => {
                if (btn.onclick.toString().includes(`'${cat}',${index}`)) {
                    btn.style.background = item.vitrine ? '#10b981' : '#7c3aed';
                    btn.textContent = item.vitrine ? '‚≠ê' : '‚≠ê';
                    btn.title = item.vitrine ? 'Retirer de la vitrine' : 'Ajouter √† la vitrine';
                }
            });
            
            // Mettre √† jour l'affichage de la vitrine
            updateVitrineFromMenu();
            
            showSuccess(item.vitrine ? `${item.name} ajout√© √† la vitrine` : `${item.name} retir√© de la vitrine`);
        }

        // Fonction pour mettre √† jour la vitrine √† partir du menu
        function updateVitrineFromMenu() {
            if (!currentMenu) return;
            
            const vitrineList = document.getElementById('vitrineList');
            if (!vitrineList) return;
            
            const platsVitrine = [];
            
            // Parcourir toutes les cat√©gories et plats
            for (const [catName, items] of Object.entries(currentMenu.categories)) {
                items.forEach(item => {
                    if (item.vitrine) {
                        platsVitrine.push({
                            id: item.id || 0,
                            nom: item.name,
                            categorie: catName,
                            prix: parseFloat(item.price) || 0,
                            promo_pourcentage: item.promo_pourcentage || 0,
                            vitrine_ordre: item.vitrine_ordre || 0
                        });
                    }
                });
            }
            
            // Trier par cat√©gorie puis par ordre
            platsVitrine.sort((a, b) => {
                if (a.categorie < b.categorie) return -1;
                if (a.categorie > b.categorie) return 1;
                return a.vitrine_ordre - b.vitrine_ordre;
            });
            
            vitrineList.dataset.plats = JSON.stringify(platsVitrine);
            updateVitrineDisplay();
        }

        // Variable globale pour stocker les infos du plat en cours d'√©dition promo
        let currentPromoItem = null;

        // Fonction pour ouvrir la popup promo
        function openPromoPopup(cat, index) {
            if (!currentMenu || !currentMenu.categories[cat]) return;
            
            const item = currentMenu.categories[cat][index];
            if (!item || !item.price) {
                showError('Prix du plat manquant');
                return;
            }
            
            currentPromoItem = { cat, index, item };
            
            // Remplir les infos du plat
            document.getElementById('promoItemName').textContent = item.name;
            document.getElementById('promoPrixOriginal').textContent = parseFloat(item.price).toFixed(2) + '‚Ç¨';
            
            // Initialiser avec la promo existante ou 0
            const currentPromo = item.promo_pourcentage || 0;
            document.getElementById('promoSlider').value = currentPromo;
            document.getElementById('promoInput').value = currentPromo;
            
            // Mettre √† jour l'aper√ßu
            updatePromoPreview();
            
            // Afficher la popup
            const popup = document.getElementById('promoPopup');
            popup.style.display = 'flex';
        }



        // Fonction pour fermer la popup promo
        function closePromoPopup() {
            document.getElementById('promoPopup').style.display = 'none';
            currentPromoItem = null;
        }

        // Fonction pour mettre √† jour l'aper√ßu du prix en temps r√©el
        function updatePromoPreview() {
            if (!currentPromoItem) return;
            
            const slider = document.getElementById('promoSlider');
            const input = document.getElementById('promoInput');
            const prixOriginal = parseFloat(currentPromoItem.item.price);
            const promoPercent = parseInt(slider.value);
            
            // Synchroniser l'input avec le slider
            input.value = promoPercent;
            
            // Calculer le nouveau prix
            const reduction = prixOriginal * (promoPercent / 100);
            const nouveauPrix = prixOriginal - reduction;
            
            // Mettre √† jour l'affichage
            document.getElementById('promoPrixBarre').textContent = prixOriginal.toFixed(2) + '‚Ç¨';
            document.getElementById('promoNouveauPrix').textContent = nouveauPrix.toFixed(2) + '‚Ç¨';
            document.getElementById('promoEconomie').textContent = '-' + reduction.toFixed(2) + '‚Ç¨';
            
            // Afficher/masquer l'aper√ßu selon la promo
            const preview = document.getElementById('promoPreview');
            if (promoPercent > 0) {
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // Fonction pour synchroniser le slider depuis l'input
        function updatePromoFromInput() {
            const input = document.getElementById('promoInput');
            const slider = document.getElementById('promoSlider');
            
            let value = parseInt(input.value) || 0;
            value = Math.max(0, Math.min(50, value)); // Limiter 0-50
            
            input.value = value;
            slider.value = value;
            
            updatePromoPreview();
        }

        // Fonction pour appliquer la promotion
        function applyPromo() {
            if (!currentPromoItem) return;
            
            const promoPercent = parseInt(document.getElementById('promoSlider').value);
            const { cat, index, item } = currentPromoItem;
            
            // Mettre √† jour l'item
            item.promo_pourcentage = promoPercent;
            
            // Mettre √† jour l'affichage du bouton promo
            const buttons = document.querySelectorAll('.promo-btn');
            buttons.forEach(btn => {
                if (btn.onclick.toString().includes(`'${cat}',${index}`)) {
                    if (promoPercent > 0) {
                        btn.style.background = '#dc2626'; // Rouge pour promo active
                        btn.title = `Promo active: -${promoPercent}%`;
                    } else {
                        btn.style.background = '#f59e0b'; // Orange par d√©faut
                        btn.title = 'D√©finir une promo';
                    }
                }
            });
            
            // Mettre √† jour la vitrine si le plat y est
            updateVitrineFromMenu();
            
            // Rafra√Æchir l'affichage pour montrer le prix barr√©
            displayEditor();
            
            // Fermer la popup
            closePromoPopup();
            
            // Message de confirmation
            if (promoPercent > 0) {
                showSuccess(`Promo de ${promoPercent}% appliqu√©e √† "${item.name}"`);
            } else {
                showSuccess(`Promo retir√©e de "${item.name}"`);
            }
        }

    </script>

    <!-- POPUP PROMO -->
    <div id="promoPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:12px; max-width:500px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:#dc2626;">üè∑Ô∏è D√©finir une promotion</h3>
                <button onclick="closePromoPopup()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
            </div>
            
            <div style="margin-bottom:20px;">
                <p style="margin:0 0 10px 0; color:#666; font-weight:600;" id="promoItemName">Nom du plat</p>
                <p style="margin:0; color:#999; font-size:14px;">Prix actuel : <span id="promoPrixOriginal" style="font-weight:bold; color:#333;">0‚Ç¨</span></p>
            </div>
            
            <div style="margin-bottom:25px;">
                <label style="display:block; margin-bottom:10px; color:#666; font-weight:600;">R√©duction (%)</label>
                <div style="display:flex; align-items:center; gap:15px;">
                    <input type="range" id="promoSlider" min="0" max="50" value="0" 
                           style="flex:1; height:6px; border-radius:3px; outline:none; background:#e5e7eb; cursor:pointer;"
                           oninput="updatePromoPreview()">
                    <input type="number" id="promoInput" min="0" max="50" value="0" 
                           style="width:70px; padding:8px; border:2px solid #e5e7eb; border-radius:6px; text-align:center; font-size:18px; font-weight:bold; color:#dc2626;"
                           oninput="updatePromoFromInput()">
                    <span style="color:#dc2626; font-weight:bold; font-size:18px;">%</span>
                </div>
            </div>
            
            <div id="promoPreview" style="background:#fee2e2; padding:15px; border-radius:8px; margin-bottom:25px; border-left:4px solid #dc2626;">
                <p style="margin:0 0 5px 0; color:#7f1d1d; font-size:13px; font-weight:600;">APER√áU DU PRIX</p>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="promoPrixBarre" style="text-decoration:line-through; color:#999; font-size:18px;">0‚Ç¨</span>
                    <span style="color:#dc2626; font-size:24px; font-weight:bold;">‚Üí</span>
                    <span id="promoNouveauPrix" style="color:#ef4444; font-size:24px; font-weight:bold;">0‚Ç¨</span>
                    <span id="promoEconomie" style="background:#dc2626; color:white; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:bold; margin-left:auto;">-0‚Ç¨</span>
                </div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button onclick="closePromoPopup()" 
                        style="flex:1; padding:12px; background:#e5e7eb; color:#333; border:none; border-radius:6px; font-size:15px; font-weight:600; cursor:pointer;">
                    Annuler
                </button>
                <button onclick="applyPromo()" 
                        style="flex:1; padding:12px; background:#f59e0b; color:white; border:none; border-radius:6px; font-size:15px; font-weight:600; cursor:pointer;">
                    ‚úÖ Appliquer
                </button>
            </div>
        </div>
    </div>
    <!-- FIN POPUP PROMO -->

    <!-- Bouton flottant panier -->
    <button id="openCartBtn" onclick="openCartPopup()" style="position:fixed; bottom:20px; right:20px; background:#7c3aed; color:white; border:none; padding:15px 25px; border-radius:50px; font-size:16px; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.3); z-index:999;">
        üõí Panier (<span id="cartCount">0</span>)
    </button>

    <!-- Popup panier -->
    <div id="cartPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:12px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:#7c3aed;">üõí Panier de commande</h3>
                <button onclick="closeCartPopup()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div id="panierList" style="min-height:50px; margin-bottom:15px;">
                <p style="color:#999; text-align:center;">Panier vide</p>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:#7c3aed; color:white; border-radius:8px; margin-bottom:15px;">
                <span style="font-weight:bold; font-size:18px;">TOTAL :</span>
                <span id="panierTotal" style="font-weight:bold; font-size:24px;">0.00‚Ç¨</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="clearCart()" style="flex:1; padding:12px; background:#f59e0b; color:white; border:none; border-radius:6px; font-size:15px; font-weight:600; cursor:pointer;">Vider</button>
                <button onclick="validateOrder()" style="flex:1; padding:12px; background:#10b981; color:white; border:none; border-radius:6px; font-size:15px; font-weight:600; cursor:pointer;">‚úÖ Valider</button>
            </div>
        </div>
    </div>

</body>
</html>