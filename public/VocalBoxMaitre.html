<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocalBox Ma√Ætre - Num√©risation de Menus</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .content { padding: 40px; }
        .login-section {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }
        .login-section h2 { color: #333; margin-bottom: 30px; }
        .login-section input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .login-section input:focus { outline: none; border-color: #667eea; }
        .main-section { display: none; }
        .button-group {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .btn {
            flex: 1;
            min-width: 200px;
            padding: 20px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
            margin-bottom: 30px;
        }
        .upload-zone:hover { background: #e9ecef; border-color: #764ba2; }
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .preview-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .preview-item img { width: 100%; height: 150px; object-fit: cover; }
        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        .loading { text-align: center; padding: 40px; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .menu-editor {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .category-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .category-header h3 { color: #667eea; font-size: 1.3em; }
        .add-item-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .menu-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 2fr 1fr 2fr auto;
            gap: 10px;
            align-items: center;
        }
        .menu-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #c3e6cb;
            text-align: center;
        }
        .api-key-display {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 16px;
            word-break: break-all;
            margin: 15px 0;
            border: 2px solid #28a745;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { color: #333; }
        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }
        .error-box {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        .debug-box {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ VocalBox Ma√Ætre</h1>
            <p>Num√©risation de menus avec Claude Vision</p>
        </div>

        <div class="content">
            <!-- LOGIN -->
            <div class="login-section" id="loginSection">
                <h2>üîê Authentification</h2>
                <input type="password" id="passwordInput" placeholder="Mot de passe" onkeypress="if(event.key==='Enter')login()">
                <button class="btn btn-primary" onclick="login()">Se connecter</button>
            </div>

            <!-- MAIN -->
            <div class="main-section" id="mainSection">
                <div class="button-group">
                    <button class="btn btn-primary" onclick="openScanner()">üì∏ Scanner un menu</button>
                    <button class="btn btn-success" onclick="downloadJSON()" id="downloadBtn" disabled>üì• T√©l√©charger JSON</button>
                </div>
                <div id="resultSection"></div>
            </div>
        </div>
    </div>

    <!-- MODAL SCANNER -->
    <div class="modal" id="scannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Scanner un menu</h2>
                <button class="close-btn" onclick="closeScanner()">&times;</button>
            </div>

            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <h3>üìÅ Cliquez pour uploader vos images</h3>
                <p>Maximum 5 images, moins de 3MB chacune</p>
                <input type="file" id="fileInput" accept="image/*" multiple style="display:none" onchange="handleFiles(this.files)">
            </div>

            <div class="preview-container" id="previewContainer"></div>

            <button class="btn btn-primary" onclick="analyzeMenu()" id="analyzeBtn" disabled style="width:100%">
                ‚ö° Analyser (10-30 secondes)
            </button>

            <div id="loadingSection" class="loading" style="display:none">
                <div class="spinner"></div>
                <p>Analyse en cours avec Claude Vision...</p>
            </div>

            <div id="errorSection"></div>
            <div id="debugSection"></div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const PASSWORD = 'bouriquetJ.123';
        const API_URL = 'https://api.vokalbox.fr/api/menu-scan';
        const DEBUG = true;

        let uploadedImages = [];
        let currentMenu = null;

        // ===== UTILITAIRES =====
        function log(msg, data) {
            if (!DEBUG) return;
            console.log(msg, data);
            const el = document.getElementById('debugSection');
            el.innerHTML = `<div class="debug-box"><strong>${msg}</strong>\n${JSON.stringify(data, null, 2)}</div>`;
        }

        function showError(msg) {
            document.getElementById('errorSection').innerHTML = `<div class="error-box">‚ùå ${msg}</div>`;
        }

        function clearError() {
            document.getElementById('errorSection').innerHTML = '';
        }

        // ===== LOGIN =====
        function login() {
            if (document.getElementById('passwordInput').value === PASSWORD) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'block';
            } else {
                alert('‚ùå Mot de passe incorrect');
            }
        }

        // ===== SCANNER =====
        function openScanner() {
            document.getElementById('scannerModal').style.display = 'flex';
            uploadedImages = [];
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('debugSection').innerHTML = '';
            clearError();
        }

        function closeScanner() {
            document.getElementById('scannerModal').style.display = 'none';
        }

        function handleFiles(files) {
            clearError();
            Array.from(files).forEach(file => {
                if (file.size > 3 * 1024 * 1024) {
                    showError(`Image "${file.name}" trop lourde (max 3MB)`);
                    return;
                }
                if (uploadedImages.length >= 5) {
                    showError('Maximum 5 images');
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    clearError();
                    const dataUrl = e.target.result;
                    const mime = (dataUrl.split(';')[0].split(':')[1] || '').toLowerCase();
                    const base64 = dataUrl.split(',')[1] || '';
                    const approxBytes = Math.floor(base64.length * 3 / 4 - (base64.endsWith('==') ? 2 : (base64.endsWith('=') ? 1 : 0)));
                    const MIN_BYTES = 10 * 1024; // 10 KB
                    const ALLOWED_MIME = ['image/jpeg', 'image/png', 'image/webp'];

                    if (!ALLOWED_MIME.includes(mime)) {
                        showError(`Image "${file.name}" : type non support√© (${mime})`);
                        return;
                    }
                    if (approxBytes < MIN_BYTES) {
                        showError(`Image "${file.name}" trop petite (‚âà${Math.round(approxBytes/1024)} KB). Utilisez une photo plus grande.`);
                        return;
                    }

                    // V√©rifier dimensions r√©elles
                    const imgObj = new Image();
                    imgObj.onload = () => {
                        if (imgObj.naturalWidth < 50 || imgObj.naturalHeight < 50) {
                            showError(`Image "${file.name}" : r√©solution trop petite (${imgObj.naturalWidth}x${imgObj.naturalHeight})`);
                            return;
                        }
                        uploadedImages.push(dataUrl);
                        renderPreviews();
                    };
                    imgObj.onerror = () => {
                        showError(`Image "${file.name}" invalide`);
                    };
                    imgObj.src = dataUrl;
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviews() {
            const container = document.getElementById('previewContainer');
            container.innerHTML = uploadedImages.map((img, i) => `
                <div class="preview-item">
                    <img src="${img}">
                    <button class="remove-btn" onclick="removeImage(${i})">√ó</button>
                </div>
            `).join('');
            document.getElementById('analyzeBtn').disabled = uploadedImages.length === 0;
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            renderPreviews();
        }

        // ===== ANALYSE =====
        async function analyzeMenu() {
            if (uploadedImages.length === 0) return;

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loadingSection').style.display = 'block';
            clearError();

            try {
                log('Envoi requ√™te', { nbImages: uploadedImages.length });

                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': 'REST-001' },
                    body: JSON.stringify({ images: uploadedImages })
                });

                log('R√©ponse HTTP', { status: response.status });

                if (!response.ok) {
                    let txt = await response.text();
                    // Essayer d'extraire un message JSON si possible
                    try {
                        const json = JSON.parse(txt);
                        txt = json.error || JSON.stringify(json);
                    } catch (e) {
                        const m = txt.match(/\d{3}\s+({[\s\S]*})/);
                        if (m) {
                            try {
                                const j = JSON.parse(m[1]);
                                txt = j.error || JSON.stringify(j);
                            } catch (e2) { /* fallback */ }
                        }
                    }
                    throw new Error(`Erreur ${response.status}: ${txt}`);
                }

                const data = await response.json();
                log('Donn√©es re√ßues', data);

                // Si l'API retourne success:false, afficher message clair
                if (data && data.success === false) {
                    const serverMsg = typeof data.error === 'string' ? data.error : (data.error && data.error.message) ? data.error.message : JSON.stringify(data.error);
                    throw new Error(serverMsg || 'Erreur serveur');
                }

                // Extraction des cat√©gories (compatible plusieurs formats)
                let categories = {};
                let restaurantName = '';

                if (data.data && data.data.categories) {
                    // Format: { data: { restaurant, categories: [...] } }
                    restaurantName = data.data.restaurant || '';
                    data.data.categories.forEach(cat => {
                        const catName = cat.name || 'Divers';
                        categories[catName] = (cat.items || []).map(item => ({
                            name: item.name || item.nom || '',
                            price: extractPrice(item),
                            description: item.description || ''
                        }));
                    });
                } else if (data.categories) {
                    // Format: { restaurant, categories: [...] }
                    restaurantName = data.restaurant || '';
                    data.categories.forEach(cat => {
                        const catName = cat.name || 'Divers';
                        categories[catName] = (cat.items || []).map(item => ({
                            name: item.name || item.nom || '',
                            price: extractPrice(item),
                            description: item.description || ''
                        }));
                    });
                } else if (data.items) {
                    // Format legacy: { items: [...] }
                    restaurantName = data.restaurantName || '';
                    data.items.forEach(item => {
                        const catName = item.category || 'Divers';
                        if (!categories[catName]) categories[catName] = [];
                        categories[catName].push({
                            name: item.name || '',
                            price: parseFloat(item.price) || 0,
                            description: item.description || ''
                        });
                    });
                }

                if (Object.keys(categories).length === 0) {
                    throw new Error('Aucun plat d√©tect√©');
                }

                currentMenu = { restaurantName, categories };
                log('Menu trait√©', currentMenu);

                closeScanner();
                displayEditor();
                document.getElementById('downloadBtn').disabled = false;

            } catch (err) {
                showError(err.message);
                log('Erreur', { message: err.message });
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function extractPrice(item) {
            if (item.price !== undefined) return parseFloat(item.price) || 0;
            if (item.prix !== undefined) return parseFloat(item.prix) || 0;
            if (item.prices && item.prices.length > 0) {
                return parseFloat(item.prices[0].value) || 0;
            }
            return 0;
        }

        // ===== EDITEUR =====
        function displayEditor() {
            const section = document.getElementById('resultSection');
            const catCount = Object.keys(currentMenu.categories).length;
            const itemCount = Object.values(currentMenu.categories).flat().length;

            let html = `
                <div class="menu-editor">
                    <div class="form-group">
                        <label>Nom du restaurant</label>
                        <input type="text" id="restaurantName" value="${esc(currentMenu.restaurantName)}" placeholder="Nom du restaurant">
                    </div>
                    <div class="form-group">
                        <label>Code restaurant (ex: LAPART001)</label>
                        <input type="text" id="restaurantCode" placeholder="Code unique du restaurant">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="phoneNumber" placeholder="Ex: 01234567890">
                    </div>
                    <div class="form-group">
                        <label>Adresse (rue)</label>
                        <input type="text" id="addressStreet" placeholder="123 Rue de la Pizza">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div class="form-group">
                            <label>Code postal</label>
                            <input type="text" id="addressPostal" placeholder="75001">
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <input type="text" id="addressCity" placeholder="Paris">
                        </div>
                    </div>
                    <h3 style="margin-bottom:20px">üìã ${catCount} cat√©gories, ${itemCount} plats</h3>
            `;

            for (const [catName, items] of Object.entries(currentMenu.categories)) {
                html += `
                    <div class="category-section">
                        <div class="category-header">
                            <h3>${esc(catName)}</h3>
                            <button class="add-item-btn" onclick="addItem('${escJs(catName)}')">+ Ajouter</button>
                        </div>
                `;
                items.forEach((item, i) => {
                    html += `
                        <div class="menu-item">
                            <input type="text" value="${esc(item.name)}" placeholder="Nom" onchange="updateItem('${escJs(catName)}',${i},'name',this.value)">
                            <input type="number" step="0.01" value="${item.price||''}" placeholder="Prix" onchange="updateItem('${escJs(catName)}',${i},'price',this.value)">
                            <input type="text" value="${esc(item.description)}" placeholder="Description" onchange="updateItem('${escJs(catName)}',${i},'description',this.value)">
                            <button class="delete-btn" onclick="deleteItem('${escJs(catName)}',${i})">üóëÔ∏è</button>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            html += `
                <button class="btn btn-success" onclick="saveMenu()" style="width:100%;margin-top:20px">
                    üíæ Sauvegarder et g√©n√©rer cl√© API
                </button>
            </div>`;

            section.innerHTML = html;
        }

        function esc(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function escJs(str) {
            if (!str) return '';
            return String(str).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
        }

        function updateItem(cat, index, field, value) {
            if (field === 'price') {
                currentMenu.categories[cat][index][field] = parseFloat(value) || 0;
            } else {
                currentMenu.categories[cat][index][field] = value;
            }
        }

        function deleteItem(cat, index) {
            if (!confirm('Supprimer ce plat ?')) return;
            currentMenu.categories[cat].splice(index, 1);
            if (currentMenu.categories[cat].length === 0) {
                delete currentMenu.categories[cat];
            }
            displayEditor();
        }

        function addItem(cat) {
            currentMenu.categories[cat].push({ name: '', price: 0, description: '' });
            displayEditor();
        }

        // ===== SAUVEGARDE =====
        async function saveMenu() {
            const name = document.getElementById('restaurantName').value.trim();
            const restaurantCode = document.getElementById('restaurantCode').value.trim();
            
            if (!name) return alert('Entrez le nom du restaurant');
            if (!restaurantCode) return alert('Entrez le code du restaurant');
            if (!confirm(`Sauvegarder "${name}" ?`)) return;

            try {
                // Collecter les donn√©es du formulaire
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const addressStreet = document.getElementById('addressStreet').value.trim();
                const addressPostal = document.getElementById('addressPostal').value.trim();
                const addressCity = document.getElementById('addressCity').value.trim();
                
                // Pr√©parer le payload
                const payload = {
                    restaurantName: name,
                    restaurantCode: restaurantCode,
                    phoneNumber: phoneNumber || undefined,
                    address: {
                        street: addressStreet || undefined,
                        postalCode: addressPostal || undefined,
                        city: addressCity || undefined
                    },
                    menuData: {
                        categories: currentMenu.categories
                    }
                };

                const response = await fetch(`${API_URL}/save-with-restaurant`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': 'REST-001' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                log('Sauvegarde', result);

                if (!response.ok || result.success === false) {
                    throw new Error(result.message || 'Erreur sauvegarde');
                }

                const apiKey = result.apiKey || result.api_key || 'Non g√©n√©r√©';
                const count = result.itemsCount || result.totalPlats || Object.values(currentMenu.categories).flat().length;

                document.getElementById('resultSection').innerHTML = `
                    <div class="success-message">
                        <h3>‚úÖ Menu sauvegard√© !</h3>
                        <p><strong>Restaurant :</strong> ${esc(name)}</p>
                        <p><strong>Code :</strong> ${esc(restaurantCode)}</p>
                        <p><strong>Plats :</strong> ${count}</p>
                        <h4 style="margin-top:15px">üîë Cl√© API :</h4>
                        <div class="api-key-display">${esc(apiKey)}</div>
                        <p><small>Conservez cette cl√© pour VocalBoxCommande</small></p>
                        <button class="btn btn-primary" onclick="location.reload()" style="margin-top:15px">
                            üì∏ Nouveau scan
                        </button>
                    </div>
                `;

            } catch (err) {
                alert('‚ùå ' + err.message);
            }
        }

        // ===== DOWNLOAD =====
        function downloadJSON() {
            if (!currentMenu) return;
            const name = document.getElementById('restaurantName')?.value || 'menu';
            const blob = new Blob([JSON.stringify(currentMenu, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name.replace(/\s+/g, '-').toLowerCase() + '.json';
            a.click();
        }
    </script>
</body>
</html>